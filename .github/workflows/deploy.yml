name: Spring Boot CI/CD with Git Pull

# 'main' 브랜치에 푸시될 때 워크플로우 실행
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. EC2에 원격으로 접속하여 배포 스크립트를 실행
      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@master
        with:
            host: ${{ secrets.AWS_EC2_HOST }}
            username: ubuntu
            key: ${{ secrets.AWS_EC2_PEM_KEY }}
            script: |
              # 1. 프로젝트 폴더로 이동, 없으면 클론
              if [ ! -d "/home/ubuntu/hanium_iot" ]; then
                git clone https://github.com/hurosuo/hanium_iot.git /home/ubuntu/hanium_iot
              fi
              cd /home/ubuntu/hanium_iot
              git pull
              
              # 2. 백엔드 프로젝트 폴더로 이동
              cd ./hanium_project
              
              # 3. 기존 서버 종료
              PID=$(pgrep -f hanium_project-0.0.1-SNAPSHOT.jar)
              if [ -n "$PID" ]; then
                echo "Stopping server with PID: $PID"
                kill -15 $PID
                # 종료될 때까지 최대 10초 대기
                for i in {1..10}; do
                  if ! ps -p $PID > /dev/null; then
                    break
                  fi
                  sleep 1
                done
              fi
              
              # 4. Gradle 빌드 (테스트 건너뛰기)
              chmod +x ./gradlew
              ./gradlew build -x test
              
              # 5. ✅ 메모리 옵션을 포함하여 새 서버 실행
              echo "Starting new server..."
              nohup java -Xms256m -Xmx512m -jar -Dspring.profiles.active=prod ./build/libs/hanium_project-0.0.1-SNAPSHOT.jar &
