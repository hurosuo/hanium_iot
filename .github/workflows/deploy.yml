name: Spring Boot CI/CD with Git Pull

# 'main' ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. EC2ì— ì›ê²©ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰
      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@master
        with:
            host: ${{ secrets.AWS_EC2_HOST }}
            username: ubuntu
            key: ${{ secrets.AWS_EC2_PEM_KEY }}
            script: |
              set -ex # ðŸ‘ˆ 1. ê° ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ë¨¼ì € ì¶œë ¥í•˜ê³ , ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
              
              # 2. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™, ì—†ìœ¼ë©´ í´ë¡ 
              if [ ! -d "/home/ubuntu/hanium_iot" ]; then
                git clone https://github.com/hurosuo/hanium_iot.git /home/ubuntu/hanium_iot
              fi
              cd /home/ubuntu/hanium_iot
              git pull
              
              # 3. ë°±ì—”ë“œ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
              cd ./hanium_project
              
              # 4. ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ
              PID=$(pgrep -f hanium_project-0.0.1-SNAPSHOT.jar)
              if [ -n "$PID" ]; then
                echo "Stopping server with PID: $PID"
                kill -15 $PID
                sleep 5
              fi
              
              # 5. Gradle ë¹Œë“œ
              echo ">>> Start Gradle build"
              chmod +x ./gradlew
              ./gradlew build -x test
              echo ">>> Finish Gradle build"
              
              # 6. ìƒˆ ì„œë²„ ì‹¤í–‰
              echo ">>> Starting new server..."
              nohup java -Xms256m -Xmx512m -jar -Dspring.profiles.active=prod ./build/libs/hanium_project-0.0.1-SNAPSHOT.jar &
              echo ">>> Server start command executed"