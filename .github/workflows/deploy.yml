name: Spring Boot CI/CD with Git Pull

# 'main' ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. EC2ì— ì›ê²©ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰
      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ubuntu # ğŸ‘ˆ EC2 OSê°€ Amazon Linuxë©´ 'ec2-user'ë¡œ ë³€ê²½
          key: ${{ secrets.AWS_EC2_PEM_KEY }}
          script: |
            # 1. hanium_iot í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™ (ì—†ìœ¼ë©´ GitHubì—ì„œ í´ë¡ )
            if [ ! -d "/home/ubuntu/hanium_iot" ]; then
              git clone https://github.com/hurosuo/hanium_iot.git
            fi
            cd /home/ubuntu/hanium_iot
            git pull
            
            # 2. hanium_project ë°±ì—”ë“œ í´ë”ë¡œ ì´ë™
            cd ./hanium_project
            
            # 3. ê¸°ì¡´ì— ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            PID=$(pgrep -f hanium_project-0.0.1-SNAPSHOT.jar)
            if [ -n "$PID" ]; then
              echo "Stopping server with PID: $PID"
              kill -9 $PID
              sleep 5
            fi
            
            # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x ./gradlew
            
            # 5. í”„ë¡œì íŠ¸ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ëŠ” ê±´ë„ˆë›°ê¸°)
            ./gradlew build -x test
            
            # 6. ìƒˆë¡œ ë¹Œë“œëœ .jar íŒŒì¼ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
            echo "Starting new server..."
            nohup java -Xms256m -Xmx512m -jar -Dspring.profiles.active=prod ./build/libs/hanium_project-0.0.1-SNAPSHOT.jar &